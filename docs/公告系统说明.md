# 公告系统使用说明

## 功能概述

公告系统允许开发者向用户推送重要通知和信息，与自动更新系统完美集成。

## 工作原理

### 1. 服务器配置

在服务器上与 `version.json` 同级目录放置 `announcement.txt` 文件：

```
服务器目录/
├── version.json          # 版本信息
└── announcement.txt      # 公告内容
```

### 2. 公告文件格式

`announcement.txt` 是纯文本文件（UTF-8 编码），支持多行内容：

```text
📢 重要公告

尊敬的用户：

1. 服务器将于明天凌晨 2:00-4:00 进行维护升级
2. 维护期间可能无法使用自动更新功能
3. 新增了多源下载支持，下载速度更快更稳定

感谢您的支持！

--- Stellaris DLC Helper 开发团队
2024年1月15日
```

### 3. 显示逻辑

程序会在以下情况显示公告：

#### 自动检查更新（启动时）
- **有强制更新** → 显示更新对话框（公告在下方）
- **有公告但无强制更新** → 显示公告对话框
- **无强制更新且无公告** → 不显示任何对话框

#### 手动检查更新
- **有更新或有公告** → 显示对话框（根据情况显示更新/公告/两者）
- **无更新且无公告** → 提示"当前已是最新版本，也没有新的系统公告"

### 4. 界面展示

#### 场景 A：只有公告
```
┌─────────────────────────────┐
│      📢 系统公告              │
├─────────────────────────────┤
│                             │
│  [公告内容显示区域]           │
│  支持多行文本                 │
│  自动换行                     │
│                             │
├─────────────────────────────┤
│               [知道了]        │
└─────────────────────────────┘
```

#### 场景 B：只有更新
```
┌─────────────────────────────┐
│   发现新版本 2.0.0            │
├─────────────────────────────┤
│  当前版本: 1.5.0              │
│  最新版本: 2.0.0              │
│  发布日期: 2024-01-15         │
│                             │
│  [更新日志显示区域]            │
│                             │
├─────────────────────────────┤
│  [稍后提醒]    [立即更新]     │
└─────────────────────────────┘
```

#### 场景 C：更新 + 公告
```
┌─────────────────────────────┐
│   发现新版本 2.0.0            │
├─────────────────────────────┤
│  当前版本: 1.5.0              │
│  最新版本: 2.0.0              │
│                             │
│  [更新日志显示区域（较小）]    │
│                             │
│      📢 系统公告              │
│  [公告内容显示区域（较小）]    │
│                             │
├─────────────────────────────┤
│  [稍后提醒]    [立即更新]     │
└─────────────────────────────┘
```

## 技术实现

### 配置文件

在 `src/config.py` 中已配置公告 URL：

```python
ANNOUNCEMENT_URL = f"{UPDATE_URL_BASE}announcement.txt"
```

### 核心代码

#### 1. 获取公告（updater.py）

```python
def fetch_announcement(self) -> str:
    """获取公告内容"""
    try:
        response = requests.get(ANNOUNCEMENT_URL, timeout=10)
        if response.status_code == 200:
            return response.text.strip()
    except Exception as e:
        self.logger.warning(f"获取公告失败: {e}")
    return ""
```

#### 2. 检查更新（同时获取公告）

```python
def check_for_updates(self, callback: Callable[[Optional[UpdateInfo], str], None]):
    """检查更新（同时获取公告）
    
    Args:
        callback: 回调函数，接收 (update_info, announcement) 两个参数
    """
    # ... 检查更新逻辑
    announcement = self.fetch_announcement()
    callback(update_info, announcement)
```

#### 3. 显示对话框（update_dialog.py）

```python
class UpdateDialog(ctk.CTkToplevel):
    def __init__(self, parent, update_info: Optional[UpdateInfo] = None, announcement: str = ""):
        self.update_info = update_info
        self.announcement = announcement
        # ... 根据是否有更新和公告动态调整界面
```

## 测试方法

使用提供的测试脚本：

```bash
python tools/test_announcement.py
```

测试选项：
1. 只有更新，没有公告
2. 只有公告，没有更新
3. 既有更新，又有公告
4. 真实的更新检查（连接服务器）

## 部署指南

### 发布公告

1. 在服务器上创建/编辑 `announcement.txt`
2. 用户下次启动程序或手动检查更新时会看到公告
3. 公告内容可以随时更新，立即生效

### 移除公告

删除或清空服务器上的 `announcement.txt` 文件即可

### 最佳实践

1. **内容简洁**：公告应简明扼要，避免过长
2. **格式清晰**：使用 emoji 和换行增强可读性
3. **及时更新**：重要事项后及时移除过期公告
4. **与更新配合**：新版本发布时可以在公告中说明重要改进

## 示例公告

### 维护通知
```text
📢 维护通知

服务器将于 2024-01-20 02:00-04:00 进行维护。
维护期间自动更新功能可能暂时不可用。

给您带来的不便，敬请谅解！
```

### 新功能发布
```text
🎉 新功能上线

v2.0.0 已发布！

✨ 新增多源下载，速度提升 3 倍
🔧 优化了界面体验
🐛 修复了若干问题

欢迎更新体验！
```

### 紧急通知
```text
⚠️ 重要提示

由于第三方 API 变更，旧版本可能无法正常使用。
请尽快更新到最新版本！

--- 2024-01-15
```

## 常见问题

### Q: 公告文件为空会怎样？
A: 程序会当作没有公告，不影响正常运行。

### Q: 如果服务器无法访问？
A: 程序会静默失败，不会显示错误，用户体验不受影响。

### Q: 可以使用 HTML 格式吗？
A: 不支持，只支持纯文本。但可以使用 emoji 美化。

### Q: 公告内容有长度限制吗？
A: 没有硬性限制，但建议不超过 500 字，确保界面美观。

### Q: 可以在公告中添加链接吗？
A: 纯文本链接可以显示，但不会自动变成可点击的超链接。

## 后续改进方向

- [ ] 支持 Markdown 格式
- [ ] 添加公告已读标记（不重复显示）
- [ ] 支持多个公告轮播
- [ ] 添加公告优先级（紧急/一般/提示）
- [ ] 支持公告带图片

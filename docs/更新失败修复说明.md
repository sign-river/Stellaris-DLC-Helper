# 更新失败修复说明

## 问题描述

从 v1.0.3 更新到 v1.0.4 时失败，错误信息：
```
[06:12:50] 解压更新包到: C:\Users\32173\AppData\Local\Temp\stellaris_update_m9uaqyms\extracted
✗ [06:12:50] 无法确定更新源目录
✗ [06:12:50] 更新安装失败
```

## 问题原因

打包后的主程序文件名为 `点击此处运行.exe`，但更新系统中的文件识别逻辑只检查 `Stellaris-DLC-Helper.exe` 和 `main.py`，导致无法正确识别更新包内容。

## 修复内容

### 1. 修改 `src/core/updater.py`

#### 1.1 `_find_source_dir` 函数
- **修改前**：只检查 `Stellaris-DLC-Helper.exe` 和 `main.py`
- **修改后**：支持多种主程序名称：
  - `Stellaris-DLC-Helper.exe` (旧版本)
  - `点击此处运行.exe` (新版本)
  - `main.py` (开发环境)

#### 1.2 `_create_backup` 函数
- **修改前**：只备份 `Stellaris-DLC-Helper.exe`
- **修改后**：同时备份两种主程序名称

### 2. 修改 `src/utils/updater_helper.py`

#### 2.1 启动程序逻辑
- **修改前**：只尝试启动 `Stellaris-DLC-Helper.exe`
- **修改后**：按优先级尝试启动：
  1. `点击此处运行.exe` (新版本)
  2. `Stellaris-DLC-Helper.exe` (旧版本)

## 技术细节

### 文件识别优先级
```python
main_files = ["Stellaris-DLC-Helper.exe", "点击此处运行.exe", "main.py"]
```

### 更新流程
1. 下载更新包（ZIP 文件）
2. 解压到临时目录
3. **识别更新源目录**（此处是修复重点）
4. 创建备份
5. 执行文件替换
6. 启动新版本程序

## 兼容性

此修复保证了：
- ✅ 新版本（使用 `点击此处运行.exe`）可以正常更新
- ✅ 旧版本（使用 `Stellaris-DLC-Helper.exe`）仍然可以更新
- ✅ 开发环境（使用 `main.py`）仍然可以测试更新功能
- ✅ 向后兼容，不影响已有用户

## 测试建议

1. 从 v1.0.3 更新到修复后的版本
2. 验证更新成功
3. 检查主程序是否正常启动
4. 验证配置文件是否正确保留

## 修改文件列表

- [src/core/updater.py](../src/core/updater.py)
- [src/utils/updater_helper.py](../src/utils/updater_helper.py)

## 日期

2026年1月13日

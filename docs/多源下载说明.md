# 多源下载说明

本文档详细说明项目中的多源下载逻辑、智能源选择、测速系统、断点续传等核心机制。

## 概要

项目实现了一套智能的多源下载系统，包含4个下载源，通过自动测速和智能故障转移，确保用户总能获得可用的下载源。

## 源与三层选源逻辑

### 源的基本信息

| 源 | 优先级 | 用途 | 说明 |
|----|----|------|------|
| **R2** | 优先 | 全球CDN | 需梯子，速度快 |
| **GitHub** | 优先 | 全球CDN | 需梯子，稳定 |
| **国内云** | 默认 | 国内直连 | 无需梯子，**默认源** |
| **Gitee** | 保底 | 稳定保底 | 无需梯子，**保底源** |

### 三层选源逻辑（智能测速）

#### 第一层：优选快速源 🚀

自动测试所有源，选择达到阈值的最快源：

```
逻辑流程：
1. 测试 R2 (阈值 2.5 MB/s)
   ✅ 达标 → 返回 R2（有梯子用户最优）
   ❌ 不达标 → 继续测试

2. 测试 GitHub (阈值 2.5 MB/s)
   ✅ 达标 → 返回 GitHub
   ❌ 不达标 → 继续测试

3. 测试国内云 (阈值 3.0 MB/s)
   ✅ 达标 → 返回国内云
   ❌ 不达标 → 继续测试

4. 测试 Gitee (仅记录速度，不做判断)
   ✅ 记录完成 → 进入第二层
```

**阈值设计**：
- R2/GitHub 2.5 MB/s = 筛选有梯子的用户
- 国内云 3.0 MB/s = 避开拥挤时段
- Gitee 不参与 = 保留测速展示，作为保底

#### 第二层：默认源保底 ⚠️

```
触发条件：所有源都不达标

动作：自动使用国内云

理由：
  ✅ 程序主要面向国内用户
  ✅ 配置问题时的安全选项
  ✅ 相对稳定的下载体验
```

#### 第三层：连接保底 💾

```
触发条件：连国内云都无法测速

动作：自动使用 Gitee

理由：
  ✅ Gitee 连接非常稳定
  ✅ 速度较慢但可靠 (2-3 MB/s)
  ✅ 最后的保障源
```

## URL 生成规则

### 基本流程

1. **获取DLC列表**：从国内云获取 `index.json`
2. **提取相对路径**：例如 `281990/dlc001_symbols_of_domination.zip`
3. **生成各源URL**：
   - R2: 直接使用
   - GitHub: 使用pairings.json映射
   - 国内云: 直接使用
   - Gitee: 使用pairings.json和release tag

### 文件映射

- **pairings.json**: 原始文件名 → 数字格式
  - `dlc001_symbols_of_domination.zip` → `001.zip`
- **Gitee Release Tag**: 按编号范围分组
  - 001-050 in `v1_001-050`

## 测速系统详解

### 测速过程

程序进行10秒实际下载测试，每2秒实时报告速度：

```
第2秒：  已下载 X MB，当前速度 Y.YY MB/s  ← 实时报告①
第4秒：  已下载 X MB，当前速度 Y.YY MB/s  ← 实时报告②
第6秒：  已下载 X MB，当前速度 Y.YY MB/s  ← 实时报告③
第8秒：  已下载 X MB，当前速度 Y.YY MB/s  ← 实时报告④
第10秒: 已下载 X MB，当前速度 Y.YY MB/s  ← 最终报告⑤

【判断】
if Y.YY > threshold:
    ✅ 结果：速度达标
else:
    ❌ 结果：速度未达标
```

### 智能缓存

- **缓存时间**：5分钟有效期
- **缓存内容**：最佳源名称、测速速度、时间戳
- **缓存优势**：避免频繁测速消耗用户带宽
- **强制重测**：重启程序可忽略缓存

### 防止循环测速

下载过程中只在 **所有条件都满足** 时才重新测速：

```
触发条件（AND关系）：
✓ 下载超过 10秒
✓ 当前速度 < 0.3 MB/s
✓ 已下载 > 5 MB
✓ 连续5次慢速检测
✓ 距上次测速 > 30秒

为什么这样严格：
  - 避免网络波动导致频繁测速
  - 避免测速消耗用户带宽
  - 只在真正出现严重问题时才切换
```

## 关键实现点

### SourceManager 类的核心方法

```python
def get_best_download_source(self):
    """三层选源逻辑"""
    # 测试所有源
    for source in ["r2", "github", "domestic_cloud", "gitee"]:
        speed = measure_speed(source)
    
    # 第一层：选达标的最快源
    if has_qualified_source():
        return fastest_qualified_source
    
    # 第二层：默认源
    if has_domestic_cloud():
        return "domestic_cloud"
    
    # 第三层：保底源
    return "gitee"
```

### Downloader 类 - 断点续传

```
流程：
1. 检查 .tmp 文件 → 获取已下载大小
2. 发送 Range 请求 → bytes=<size>-
3. 服务器响应：
   - 206 Partial → 继续下载
   - 200 OK → 从头下载
   - 416 Range Invalid → 已完成
4. 错误重试：最多3次，继续追加
5. 完成后：SHA256校验（可选）→ 重命名.tmp
```

## 缓存与监控

### 缓存目录

```
Stellaris_DLC_Cache/
├── dlc_urls.json           # DLC多源URL映射
├── appinfo/
│   └── stellaris_appinfo.json
├── dlc/
│   └── 281990/             # 各DLC的缓存
└── operation_logs/         # 操作日志
```

### 监控日志

- **下载日志**：源、速度、耗时
- **源选择日志**：测速结果
- **快速检测日志**：后台发现的更快源

## 扩展建议

1. 用户自定义测速阈值
2. 可配置的缓存时间
3. 跨源切换时的哈希校验
4. 多源并行下载

## 测试脚本

- `tools/test_get_best.py` - 测速选源
- `tools/connectivity_test.py` - 源连通性
- `tools/test_multi_source.py` - 多源下载

---

详细的开发文档请参考 `docs/开发文档.md`

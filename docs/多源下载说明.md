# 多源下载说明（整合）

本文件合并了项目中所有关于多源下载逻辑与实现细节，包含R2、GitHub、国内云、Gitee四个源的生成规则、优先级、测速和断点续传等内容。

（本文件整合自原英文文档的内容；原英文文档已被删除并合并为此中文版本）

## 概要
见 `docs/多源下载说明.md` 的核心说明：项目实现多源下载与智能故障转移，根据优先级尝试下载源，并支持多种格式的URL映射。

## 源与优先级
- R2：优先级1，主要下载源，使用 R2 存储桶直接提供文件
- GitHub：优先级2，使用 `pairings.json` 进行文件名映射并发布至 release
- 国内云服务器：优先级3，唯一的DLC列表来源，`index.json`在此服务器中
- Gitee：优先级4，按编号范围发布到不同 release 标签

## URL 生成规则（汇总）
- 从 `domestic_cloud`（index.json）获取 DLC 的原始 URL
- 提取相对路径（例如 `281990/dlc001_symbols_of_domination.zip`）用于 R2 或国内云的 URL 生成
- 使用 `pairings.json` 将原始文件映射到 GitHub/Gitee 发布的临时数字文件名（如 `001.zip`）
- 对 Gitee 额外根据数字范围匹配 release tag

## 测试文件与测速逻辑
- 程序优先使用 `config.json` 中 `test_url` 的显式值（若存在）
- 若未配置，程序将使用默认测试路径（例如 `https://dlc.dlchelper.top/dlc/test/test2.bin`）进行速度测量
- 新增快速检测(`find_first_source_above`)用于在Gitee下载时后台确认是否存在更快源

## 关键实现点（代码层面）
- `SourceManager.build_dlc_url_map`: 生成每个 DLC 的 `url_map`（source -> url）并写入 `Stellaris_DLC_Cache/dlc_urls.json`
- `SourceManager.measure_speed`: 支持基于 `max_seconds` / `max_bytes` 的速度测量
- `DLCDownloader._download_single_attempt`: 总是调用进度回调，支持 content-length 不存在的情形
- `Downloader` 支持断点续传、文件完整性校验（SHA256 验证）以及预检 Head 请求

## 断点续传与哈希校验
- 通过请求头 `Range` 支持断点续传
- 如果服务器返回 416（范围无效），则视为已完成，将 `.tmp` 重命名为目标文件
- 可选的哈希校验将对下载后文件进行 SHA256 校验（若配置）

## 缓存与监控
- 本地缓存目录： `Stellaris_DLC_Cache/dlc/`
- 日志记录下载统计和源选择
- 支持快速检测日志记录以便于诊断

## 扩展建议
- 建议在 `config.json` 中暴露 Gitee 快速检测参数（阈值、检测间隔、是否允许自动替换）以便用户配置
- 进一步实现 ETag / Last-Modified 校验以增强跨源断点续传一致性

## 测试脚本
- `tools/test_get_best.py`：用于测量服务并选取最佳源
- `tools/show_test_candidates.py`：显示每个源对应的测试 URL
- `tools/connectivity_test.py`：用于检测各源连通性

---
注：源文件合并后，原始单独英文文档已删除。若需要历史内容，请查看 `git` 历史记录。

# 服务器迁移指南

本文档记录了将DLC Helper服务从国内服务器迁移到GitLink（或其他平台）的完整流程。

---

## 📊 当前服务器架构

### 国内服务器 (http://47.100.2.190)

提供以下服务：

#### 1. DLC文件服务 (`/dlc/`)
- **index.json** - DLC元数据列表（从另一个项目自动生成）
- **DLC文件** - 39个DLC压缩包
  - 路径格式：`/dlc/281990/dlc001_symbols_of_domination.zip`
- **测速文件** - `test/test.bin` (用于源速度测试)

#### 2. 程序更新服务 (`/update/`)
- **version.json** - 版本信息和更新包下载链接
- **announcement.txt** - 系统公告（UTF-8编码）
- **更新包** - 如 `Stellaris-DLC-Helper-v1.0.3.zip`

#### 3. AppInfo服务 (`/appinfo/`)
- **stellaris_appinfo.json** - Steam DLC ID映射表
  - 用途：生成CreamAPI破解补丁配置文件

---

## 🎯 迁移目标平台

### GitLink 平台特点
- ✅ 国内访问快速，无需翻墙
- ✅ 无下载速度限制（相比Gitee）
- ✅ 支持Release功能（类似GitHub）
- ✅ Release文件大小无限制
- ✅ URL格式：`https://gitlink.org.cn/用户名/仓库名/releases/download/Tag名/文件名`

### 其他备选平台
- GitHub (已有，保留作为备用源)
- Gitee (已有，保留作为备用源)
- 其他对象存储 (R2, OSS等)

---

## 📦 GitLink仓库结构规划

### 推荐结构（3个Release Tag）

```
仓库名: Stellaris-Files 或 Stellaris-DLC-Storage

📦 Release Tag: "dlc-full"
│   用途：存储所有DLC文件和测速文件
│
├── 001.zip          → 对应 dlc001_symbols_of_domination.zip
├── 002.zip          → 对应 dlc002_arachnoid.zip
├── 003.zip          → 对应 dlc003_signup_bonus.zip
├── ...
├── 039.zip          → 对应 dlc039_biogenesis.zip
└── test.bin         → 测速文件 (10-100MB)

📦 Release Tag: "metadata-v1" (或 "metadata-latest")
│   用途：存储元数据文件
│
├── index.json               → DLC列表元数据（从上传项目生成）
└── stellaris_appinfo.json   → Steam DLC ID映射表

📦 Release Tag: "v1.0.3" (版本号递增)
│   用途：存储程序更新包
│
├── Stellaris-DLC-Helper-v1.0.3.zip   → 程序安装包
├── version.json                       → 版本信息
└── announcement.txt                   → 系统公告
```

---

## 📋 完整文件清单

### 1. DLC文件包 (Tag: dlc-full)

**需要上传的文件：39个DLC + 1个测速文件**

使用 `pairings.json` 中的映射关系进行重命名：

```json
映射关系参考 (pairings.json)：
{
  "dlc001_symbols_of_domination.zip": "001.zip",
  "dlc002_arachnoid.zip": "002.zip",
  "dlc003_signup_bonus.zip": "003.zip",
  "dlc004_plantoid.zip": "004.zip",
  "dlc010_creatures_of_the_void.zip": "010.zip",
  "dlc012_leviathans.zip": "012.zip",
  "dlc013_horizon_signal.zip": "013.zip",
  "dlc014_utopia.zip": "014.zip",
  "dlc015_anniversary.zip": "015.zip",
  "dlc016_synthetic_dawn.zip": "016.zip",
  "dlc017_apocalypse.zip": "017.zip",
  "dlc018_humanoids.zip": "018.zip",
  "dlc019_distant_stars.zip": "019.zip",
  "dlc020_megacorp.zip": "020.zip",
  "dlc021_ancient_relics.zip": "021.zip",
  "dlc022_lithoids.zip": "022.zip",
  "dlc023_federations.zip": "023.zip",
  "dlc024_necroids.zip": "024.zip",
  "dlc025_nemesis.zip": "025.zip",
  "dlc026_aquatics.zip": "026.zip",
  "dlc027_overlord.zip": "027.zip",
  "dlc028_toxoids.zip": "028.zip",
  "dlc029_first_contact.zip": "029.zip",
  "dlc030_galactic_paragons.zip": "030.zip",
  "dlc031_astral_planes.zip": "031.zip",
  "dlc032_expansion_pass_five.zip": "032.zip",
  "dlc033_the_machine_age.zip": "033.zip",
  "dlc034_cosmic_storms.zip": "034.zip",
  "dlc035_grand_archive.zip": "035.zip",
  "dlc036_season_08.zip": "036.zip",
  "dlc037_rick_the_cube.zip": "037.zip",
  "dlc038_infernals.zip": "038.zip",
  "dlc039_biogenesis.zip": "039.zip"
}
```

**测速文件生成**：
```bash
# Linux/Mac
dd if=/dev/zero of=test.bin bs=1M count=50

# Windows (PowerShell)
fsutil file createnew test.bin 52428800  # 50MB
```

### 2. 元数据文件 (Tag: metadata-v1)

#### index.json
**来源**: 由另一个DLC上传/管理项目自动生成

**格式**:
```json
{
  "281990": {
    "dlcs": {
      "dlc001": {
        "name": "Symbols Of Domination",
        "url": "https://gitlink.org.cn/用户名/仓库名/releases/download/dlc-full/001.zip",
        "size": "75.6KB",
        "checksum": "sha256哈希值"
      },
      "dlc002": { ... },
      ...
    }
  }
}
```

**注意**: 
- URL需要指向GitLink的DLC文件
- 由上传工具自动生成后上传到此Tag

#### stellaris_appinfo.json
**来源**: 项目中已有 `Stellaris_DLC_Cache/appinfo/stellaris_appinfo.json`

**用途**: 提供Steam DLC ID映射，用于生成CreamAPI配置

**格式**:
```json
{
  "app_id": "281990",
  "name": "Stellaris",
  "update_time": "2025-11-30 20:09:13",
  "dlcs": [
    {
      "id": "498870",
      "name": "Stellaris: Plantoids Species Pack"
    },
    ...
  ]
}
```

### 3. 程序更新文件 (Tag: v1.0.x)

#### version.json
**格式**:
```json
{
  "latest_version": "1.0.3",
  "release_date": "2026-01-12",
  "update_url": "https://gitlink.org.cn/用户名/仓库名/releases/download/v1.0.3/Stellaris-DLC-Helper-v1.0.3.zip",
  "file_size": "15.2MB",
  "checksum": "sha256哈希值",
  "force_update": false,
  "min_version": "1.0.0",
  "changelog": "更新内容...",
  "announcement": "可选的公告内容"
}
```

#### announcement.txt
**格式**: 纯文本，UTF-8编码
```
系统公告内容
支持多行
Markdown格式
```

#### Stellaris-DLC-Helper-vX.X.X.zip
程序发布包（通过 `python build.py` 生成）

---

## 🔧 配置文件修改

### 修改 config.json

```json
{
  "version": "1.0.3",
  "stellaris_app_id": "281990",
  "server": {
    "update_url_base": "https://gitlink.org.cn/用户名/仓库名/releases/download/v1.0.3/",
    "sources": [
      {
        "name": "gitlink",
        "url": "https://gitlink.org.cn/用户名/仓库名/releases/download/dlc-full/",
        "priority": 1,
        "enabled": true,
        "format": "github_release",
        "mapping_file": "pairings.json",
        "test_url": "https://gitlink.org.cn/用户名/仓库名/releases/download/dlc-full/test.bin"
      },
      {
        "name": "github",
        "url": "https://github.com/sign-river/File_warehouse/releases/download/ste4.2/",
        "priority": 2,
        "enabled": true,
        "format": "github_release",
        "mapping_file": "pairings.json",
        "test_url": "https://github.com/sign-river/File_warehouse/releases/download/test/test.bin"
      },
      {
        "name": "gitee",
        "url": "https://gitee.com/signriver/file_warehouse",
        "priority": 3,
        "enabled": true,
        "format": "gitee_release",
        "mapping_file": "pairings.json",
        "releases": {
          "ste1-26": { "min": 1, "max": 26 },
          "ste27-39": { "min": 27, "max": 39 }
        },
        "test_url": "https://gitee.com/signriver/file_warehouse/releases/download/test/test.bin"
      }
    ],
    "timeout": 30,
    "appinfo_url": "https://gitlink.org.cn/用户名/仓库名/releases/download/metadata-v1/stellaris_appinfo.json"
  },
  "network": {
    "chunk_size": 8192,
    "retry_times": 3
  },
  "cache": {
    "dir_name": "Stellaris_DLC_Cache",
    "dlc_subdir": "dlc",
    "log_subdir": "operation_logs"
  }
}
```

### 修改 src/config.py

```python
# 更新服务器配置
UPDATE_URL_BASE = get_config("server", "update_url_base", 
    default="https://gitlink.org.cn/用户名/仓库名/releases/download/v1.0.3/")
UPDATE_CHECK_URL = f"{UPDATE_URL_BASE}version.json"
ANNOUNCEMENT_URL = f"{UPDATE_URL_BASE}announcement.txt"

# AppInfo URL
APPINFO_URL = get_config("server", "appinfo_url", 
    default="https://gitlink.org.cn/用户名/仓库名/releases/download/metadata-v1/stellaris_appinfo.json")
```

### 修改 src/config_loader.py

```python
DEFAULT_CONFIG = {
    "server": {
        "url": "https://gitlink.org.cn/用户名/仓库名/releases/download/dlc-full/",
        "update_url_base": "https://gitlink.org.cn/用户名/仓库名/releases/download/v1.0.3/",
        "appinfo_url": "https://gitlink.org.cn/用户名/仓库名/releases/download/metadata-v1/stellaris_appinfo.json"
    }
}
```

---

## 📝 迁移操作步骤

### 第一阶段：准备文件

1. **从国内服务器下载所有文件**
   ```bash
   # 下载所有DLC文件
   wget -r -np -nH --cut-dirs=2 http://47.100.2.190/dlc/281990/
   
   # 下载元数据
   wget http://47.100.2.190/index.json
   wget http://47.100.2.190/appinfo/stellaris_appinfo.json
   ```

2. **使用pairings.json重命名DLC文件**
   ```python
   import json
   import shutil
   from pathlib import Path
   
   with open('pairings.json', 'r', encoding='utf-8') as f:
       mappings = json.load(f)
   
   source_dir = Path('./dlc_files')
   target_dir = Path('./renamed_dlc')
   target_dir.mkdir(exist_ok=True)
   
   for original, renamed in mappings.items():
       src = source_dir / original
       dst = target_dir / renamed
       if src.exists():
           shutil.copy2(src, dst)
           print(f"✓ {original} -> {renamed}")
   ```

3. **生成测速文件**
   ```bash
   # Windows PowerShell
   fsutil file createnew test.bin 52428800  # 50MB
   
   # Linux/Mac
   dd if=/dev/zero of=test.bin bs=1M count=50
   ```

4. **准备元数据文件**
   - 从另一个项目重新生成 `index.json`（确保URL指向GitLink）
   - 复制 `Stellaris_DLC_Cache/appinfo/stellaris_appinfo.json`

5. **准备更新文件**
   - 打包最新版本：`python build.py`
   - 创建 `version.json`
   - 创建 `announcement.txt`

### 第二阶段：上传到GitLink

1. **创建GitLink仓库**
   - 登录 https://gitlink.org.cn
   - 创建新仓库（建议命名：`Stellaris-Files`）
   - 设置为公开仓库

2. **创建Release: dlc-full**
   - 进入仓库 → Releases → Create a new release
   - Tag: `dlc-full`
   - Title: `Stellaris DLC Files - Full Pack`
   - Description: `包含所有39个DLC文件和测速文件`
   - 上传文件：
     - 001.zip ~ 039.zip (39个文件)
     - test.bin
   - 发布Release

3. **创建Release: metadata-v1**
   - Tag: `metadata-v1`
   - Title: `Metadata Files`
   - Description: `DLC列表和AppInfo元数据`
   - 上传文件：
     - index.json
     - stellaris_appinfo.json
   - 发布Release

4. **创建Release: v1.0.3**
   - Tag: `v1.0.3`
   - Title: `Stellaris DLC Helper v1.0.3`
   - Description: 更新说明
   - 上传文件：
     - Stellaris-DLC-Helper-v1.0.3.zip
     - version.json
     - announcement.txt
   - 发布Release

### 第三阶段：修改本项目配置

1. **更新配置文件**
   ```bash
   # 修改 config.json
   # 修改 src/config.py
   # 修改 src/config_loader.py
   ```
   将所有URL替换为GitLink地址

2. **测试配置**
   ```bash
   # 测试DLC列表加载
   python -c "from src.core.dlc_manager import DLCManager; m=DLCManager('.'); print(m.fetch_dlc_list()[:2])"
   
   # 测试AppInfo加载
   python -c "import requests; r=requests.get('你的GitLink_appinfo_URL'); print(r.json()['app_id'])"
   
   # 测试更新检查
   python -c "import requests; r=requests.get('你的GitLink_version_URL'); print(r.json()['latest_version'])"
   ```

3. **完整功能测试**
   - 启动程序，检测游戏路径
   - 加载DLC列表（查看日志，确认从GitLink获取）
   - 测速所有源（GitLink应该最快）
   - 下载一个DLC测试
   - 安装破解补丁测试
   - 检查更新测试

### 第四阶段：更新DLC上传项目

修改另一个DLC管理/上传项目：

1. **修改index.json生成逻辑**
   - 生成的URL指向GitLink
   - 格式：`https://gitlink.org.cn/用户名/仓库名/releases/download/dlc-full/001.zip`

2. **添加自动上传到GitLink功能**
   - 使用GitLink API上传新DLC
   - 或手动上传后更新index.json

3. **同步更新metadata-v1**
   - 每次更新DLC后，重新上传index.json到metadata-v1 Tag

---

## ⚠️ 注意事项

### URL格式规范
```
GitLink Release URL格式：
https://gitlink.org.cn/{用户名}/{仓库名}/releases/download/{Tag名}/{文件名}

示例：
https://gitlink.org.cn/signriver/Stellaris-Files/releases/download/dlc-full/001.zip
https://gitlink.org.cn/signriver/Stellaris-Files/releases/download/metadata-v1/index.json
https://gitlink.org.cn/signriver/Stellaris-Files/releases/download/v1.0.3/version.json
```

### 版本更新流程
1. 打包新版本：`python build.py`
2. 创建新的Release Tag（如 v1.0.4）
3. 上传新的zip、version.json、announcement.txt
4. 修改config.json中的`update_url_base`
5. 提交代码并发布

### 元数据更新流程
1. 有新DLC时，在上传项目中添加DLC
2. 重新生成index.json（URL指向GitLink）
3. 删除旧的metadata-v1 Release
4. 重新创建metadata-v1 Release
5. 上传新的index.json和stellaris_appinfo.json

### DLC文件更新流程
1. 有新DLC时，按pairings.json映射重命名
2. 删除旧的dlc-full Release
3. 重新创建dlc-full Release
4. 上传所有DLC文件（包括新的）
5. 同步更新index.json

### 备用源策略
- 保持GitHub和Gitee作为备用源
- 设置优先级：GitLink > GitHub > Gitee
- 确保至少2个源可用

### 测速优化
- test.bin文件大小建议50-100MB
- 定期检查测速文件是否可访问
- 监控各源的实际下载速度

---

## 🔄 回滚方案

如果GitLink出现问题，快速回滚步骤：

1. **修改config.json**
   ```json
   {
     "server": {
       "sources": [
         {
           "name": "github",
           "priority": 1,  // 提升GitHub优先级
           "enabled": true
         },
         {
           "name": "gitlink",
           "priority": 2,  // 降低GitLink优先级
           "enabled": false  // 或直接禁用
         }
       ]
     }
   }
   ```

2. **使用备用更新服务器**
   - 保留一个备用的更新服务器地址
   - 在version.json中配置fallback_url

3. **启用本地缓存优先**
   - stellaris_appinfo.json会自动使用本地缓存
   - index.json可以从其他源获取

---

## 📊 监控检查清单

定期检查以下项目：

- [ ] GitLink仓库可访问性
- [ ] 所有Release Tag完整性
- [ ] DLC文件下载速度
- [ ] test.bin测速文件可用性
- [ ] index.json格式正确性
- [ ] stellaris_appinfo.json完整性
- [ ] version.json更新及时性
- [ ] announcement.txt编码正确
- [ ] 备用源（GitHub/Gitee）可用性

---

## 📚 相关文档

- [多源下载说明](多源下载说明.md)
- [部署指南](部署指南.md)
- [配置管理说明](配置管理说明.md)
- [开发文档](开发文档.md)

---

## 🎉 GitLink API集成状态

### ✅ 已实现功能

**v1.0.4 (2026-01-12)** - GitLink API集成完成

- ✅ 从GitLink API动态获取DLC列表
- ✅ 自动解析Release中的所有zip文件
- ✅ 自动获取文件大小信息
- ✅ 智能回退到index.json（兼容性）
- ✅ 内置DLC名称映射表
- ✅ 自动生成多源URL映射

### 📋 技术实现

**API端点**: 
```
https://gitlink.org.cn/api/signriver/file-warehouse/releases.json
```

**数据流程**:
```
1. 调用GitLink API获取所有Release
2. 找到tag_name为'ste'的Release
3. 遍历attachments数组，解析所有.zip文件
4. 文件名映射：001.zip -> dlc001
5. 使用内置名称表获取DLC中文名
6. 构建完整的下载URL
7. 调用SourceManager生成多源备用URL
8. 返回完整的DLC列表
```

**优势**:
- ⚡ 实时更新：上传新DLC立即生效
- 🚀 零维护：不需要手动更新index.json
- 📦 轻量级：API响应快速（<1秒）
- 🔄 可靠性：自动回退到index.json
- 🌐 多源支持：自动生成R2/GitHub/Gitee备用链接

**使用方法**:
```python
from src.core.dlc_manager import DLCManager

manager = DLCManager(game_path)
dlc_list = manager.fetch_dlc_list()  # 自动从GitLink API获取
```

---

**文档版本**: v1.1  
**最后更新**: 2026-01-12  
**维护者**: @sign-river

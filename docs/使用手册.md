# Stellaris DLC Helper - 完整使用文档

## 目录

- [项目简介](#项目简介)
- [功能特性](#功能特性)
- [快速开始](#快速开始)
- [核心功能说明](#核心功能说明)
  - [多源下载系统](#多源下载系统)
  - [智能测速机制](#智能测速机制)
  - [自动更新系统](#自动更新系统)
  - [公告系统](#公告系统)
- [常见问题](#常见问题)
- [故障排除](#故障排除)

---

## 项目简介

Stellaris DLC Helper 是一个专为 Stellaris（群星）游戏设计的 DLC 一键解锁工具。

**主要特性：**
- 🚀 智能多源下载：自动选择最快的下载源
- ⚡ 智能测速：三级阈值策略，优选快速源
- 🔄 自动更新：无缝更新体验
- 📢 公告推送：及时获取重要通知
- 🛡️ 安全可靠：完整的错误处理机制

---

## 功能特性

### 1. 智能多源下载

程序支持多个下载源，自动测速并选择最优源：

- **R2 云存储**：海外高速源（需要梯子）
- **GitHub**：海外可靠源（需要梯子）
- **国内云服务器**：国内直连，空闲时快速
- **Gitee**：国内稳定保底，速度稳定在 2-3 MB/s

### 2. 智能测速机制

采用三级阈值策略：

| 源类型 | 阈值 | 设计目的 |
|--------|------|----------|
| R2/GitHub | 2.5 MB/s | 筛选有梯子的用户 |
| 国内云 | 3.0 MB/s | 避开拥挤时段 |
| Gitee | 0.8 MB/s | 稳定保底 |

**测速特点：**
- 10秒实际下载测试（非简单ping）
- 每2秒实时显示速度
- 5分钟智能缓存
- 防止循环测速

### 3. 自动更新

- 启动时自动检查更新
- 支持静默更新和用户确认模式
- 更新后自动重启程序

### 4. 公告系统

- 与更新检查同时进行
- 支持富文本显示
- 不干扰正常使用

---

## 快速开始

### 1. 下载与安装

从 [Releases](https://github.com/sign-river/Stellaris-DLC-Helper/releases) 下载最新版本。

### 2. 首次运行

1. 双击运行 `Stellaris_DLC_Helper.exe`
2. 程序会自动检查更新
3. 如有公告会弹窗显示

### 3. 基本使用

1. **浏览游戏路径**：点击"浏览"按钮选择 Stellaris 游戏目录
2. **选择 DLC**：勾选需要下载的 DLC
3. **下载 DLC**：点击"下载 DLC"按钮
4. **应用补丁**：点击"暂存下载"确保 DLC 正确安装
5. **启动游戏**：享受完整游戏体验

---

## 核心功能说明

### 多源下载系统

#### 工作原理

程序按优先级测试各个源：

```
1. R2 云存储 (海外)
   ↓ 如果 < 2.5 MB/s
2. GitHub (海外)
   ↓ 如果 < 2.5 MB/s
3. 国内云服务器
   ↓ 如果 < 3.0 MB/s
4. Gitee (保底)
```

#### 使用场景

**场景1：有梯子用户**
```
R2: 6.8 MB/s > 2.5 ✅
→ 选择 R2（最快）
```

**场景2：无梯子，国内云空闲**
```
R2: 0.06 MB/s < 2.5 ❌
GitHub: 0.08 MB/s < 2.5 ❌
国内云: 4.5 MB/s > 3.0 ✅
→ 选择国内云（空闲时快）
```

**场景3：无梯子，国内云拥挤**
```
R2: 0.06 MB/s < 2.5 ❌
GitHub: 0.08 MB/s < 2.5 ❌
国内云: 1.8 MB/s < 3.0 ❌
Gitee: 2.5 MB/s > 0.8 ✅
→ 选择 Gitee（稳定保底）
```

---

### 智能测速机制

#### 三层选源设计

程序采用智能的三层选源策略，确保用户能获得最佳下载速度：

**第一层：优选快速源（推荐）**
- 测试所有下载源的实际速度
- 选择达到以下阈值的最快源：
  - 🌐 R2/GitHub：**2.5 MB/s**（筛选有梯子用户）
  - 🇨🇳 国内云：**3.0 MB/s**（避开拥挤时段）
  - 📌 Gitee：仅记录速度，不参与选择（保底用）

**第二层：默认源（配置问题时）**
- 所有源都不达标时，自动使用 **国内云**
- 国内云作为默认源的理由：
  - 主要面向国内用户
  - 配置读取失败时的保底选择
  - 相对稳定的下载速度

**第三层：保底源（最后的解决方案）**
- 连默认源都无法测速时，使用 **Gitee**
- Gitee的特点：
  - 虽然速度较慢（~2-3 MB/s）
  - 但连接 **非常稳定**
  - 是最后的可靠保障

#### 测速过程

程序会进行10秒实际下载测试：

```
━━━━ 开始测试 [domestic_cloud] ━━━━
[domestic_cloud] 测速中... 2.0秒 | 已下载: 8.50 MB | 当前速度: 4.25 MB/s
[domestic_cloud] 测速中... 4.0秒 | 已下载: 17.00 MB | 当前速度: 4.25 MB/s
[domestic_cloud] 测速中... 6.0秒 | 已下载: 25.50 MB | 当前速度: 4.25 MB/s
[domestic_cloud] 测速中... 8.0秒 | 已下载: 34.00 MB | 当前速度: 4.25 MB/s
[domestic_cloud] 测速完成 (达到 10 秒时间限制)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[domestic_cloud] 测试完成
  ⏱ 测试时长: 10.00秒
  📦 下载数据: 42.50 MB
  🚀 平均速度: 4.25 MB/s
  ✅ 结果: 速度达标 (阈值: 3.0 MB/s)
```

#### 选源结果示例

| 测速结果 | 选择的源 | 说明 |
|---------|---------|------|
| R2: 3.5 MB/s | ✅ R2 | R2达标，优先选择最快源 |
| R2: 1.8 MB/s, 国内云: 4.2 MB/s | ✅ 国内云 | R2不达标，国内云达标 |
| 所有源都<阈值 | ⚠️ 国内云 | 使用默认源保证可用性 |
| 所有源都无法连接 | 💾 Gitee | 最后保底，确保不会无源可用 |

#### 智能缓存

- **缓存时间**：5分钟
- **缓存提示**：会显示缓存剩余时间
- **强制重测**：重启程序可强制重新测速

```
⚡ 使用缓存的测速结果: domestic_cloud (缓存剩余 278秒)
```

#### 防止循环测速

严格的触发条件（必须全部满足）：
- 下载时间 > 10秒
- 速度 < 0.3 MB/s（极慢）
- 已下载 > 5MB
- 连续慢速 5次
- 每30秒最多检查1次

---

### 自动更新系统

#### 更新流程

1. **启动检查**：程序启动时自动检查更新
2. **下载更新**：后台下载新版本
3. **应用更新**：下载完成后提示重启
4. **自动重启**：重启后应用新版本

#### 更新策略

- **静默模式**：后台自动更新（可配置）
- **用户确认**：弹窗询问是否更新（默认）
- **强制更新**：关键更新强制下载

#### 确认更新成功

更新后检查：
- 标题栏显示新版本号
- 日志中显示"当前版本: vX.X.X"
- `runtime_info.txt` 中记录更新时间

---

### 公告系统

#### 公告显示

启动时如有新公告会弹窗显示：

```
┌─────────────────────────────────┐
│     Stellaris DLC Helper        │
├─────────────────────────────────┤
│  📢 重要通知                     │
│                                  │
│  系统将于明天凌晨 2:00-4:00     │
│  进行维护升级。                  │
│                                  │
│  [    确定    ]                  │
└─────────────────────────────────┘
```

#### 公告特点

- 与更新检查同时进行
- 不阻塞主要功能
- 支持多行富文本
- 可配置显示方式

---

## 常见问题

### 下载相关

**Q: 下载速度很慢怎么办？**

A: 程序会自动选择最快的源。如果所有源都慢：
1. 检查本地网络连接
2. 尝试在网络较好的时段下载
3. 如有梯子可获得更好体验

**Q: 为什么一直在测速？**

A: 新版本已优化，只有在以下情况才会重测：
- 下载超过10秒且速度 < 0.3 MB/s
- 已下载 > 5MB
- 连续慢速5次
- 距上次检查 > 30秒

**Q: 测速结果会保存吗？**

A: 会！测速结果缓存5分钟，5分钟内不会重复测速。

### 更新相关

**Q: 如何确认更新成功？**

A: 检查窗口标题栏的版本号，或查看日志中的"当前版本"信息。

**Q: 更新失败怎么办？**

A: 
1. 检查网络连接
2. 手动下载最新版本
3. 确保有足够磁盘空间
4. 以管理员身份运行

**Q: 可以禁用自动更新吗？**

A: 目前不建议禁用。未来版本会添加配置选项。

### 使用相关

**Q: 为什么找不到游戏目录？**

A: 
1. 确保选择的是 Stellaris 游戏根目录
2. 目录下应包含 `stellaris.exe`
3. Steam 默认路径：`C:\Program Files (x86)\Steam\steamapps\common\Stellaris`

**Q: DLC 下载后不生效？**

A: 
1. 确保点击了"暂存下载"按钮
2. 重启游戏
3. 检查游戏版本是否匹配

**Q: 遇到错误提示怎么办？**

A: 
1. 查看日志窗口的详细信息
2. 使用"复制日志"按钮保存错误信息
3. 到 GitHub Issues 报告问题

---

## 故障排除

### 网络问题

**症状**：无法连接服务器

**解决方案**：
1. 检查防火墙设置
2. 尝试切换网络
3. 检查是否需要代理

### 权限问题

**症状**：无法写入文件

**解决方案**：
1. 以管理员身份运行
2. 检查游戏目录权限
3. 关闭杀毒软件干扰

### 磁盘空间

**症状**：下载失败

**解决方案**：
1. 清理磁盘空间（需要至少 5GB）
2. 使用"清理缓存"功能
3. 更换安装目录

### 程序崩溃

**症状**：程序意外退出

**解决方案**：
1. 检查 `runtime_info.txt` 日志
2. 删除 `Stellaris_DLC_Cache` 重新运行
3. 重新下载程序
4. 报告 Bug 到 GitHub

---

## 技术支持

- **GitHub Issues**: https://github.com/sign-river/Stellaris-DLC-Helper/issues
- **QQ群**: 1051774780

---

## 许可证

本项目仅供学习交流使用，如有侵权请立即告知删除。

**免责声明**：本工具仅作技术研究，使用者需自行承担使用风险。

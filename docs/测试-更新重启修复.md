# 测试：更新重启修复验证

## 修复内容概述

修复了自动更新完成后点击"立即重启"的两个问题：
1. **开发环境**：尝试启动不存在的 exe 文件导致报错
2. **生产环境（exe）**：PyInstaller 临时目录 `_MEI` 混淆导致 PIL 导入失败

## 测试步骤

### 测试 1：开发环境（Python 脚本模式）

**前提条件：**
- 确保已安装所有依赖：`pip install -r requirements.txt`

**步骤：**
1. 在命令行运行：`python main.py`
2. 触发自动更新（如果有可用更新）
3. 等待更新下载和安装完成
4. 点击"立即重启"按钮

**预期结果：**
- ✅ 程序应该正常重启，不会报 `FileNotFoundError` 错误
- ✅ 日志中应该显示：`开发环境：重启程序: ...`
- ✅ 新进程应该正常启动并显示主界面

### 测试 2：生产环境 - 文件可直接替换

**前提条件：**
- 已使用 `python build.py` 打包生成 exe
- exe 文件没有被其他进程锁定

**步骤：**
1. 运行 `dist\Stellaris-DLC-Helper\Stellaris-DLC-Helper.exe`
2. 触发自动更新（如果有可用更新）
3. 等待更新下载和安装完成
4. 点击"立即重启"按钮

**预期结果：**
- ✅ 程序应该启动新进程并退出当前进程
- ✅ 日志中应该显示：`exe 模式：启动新进程后退出: ...`
- ✅ 新进程应该正常启动，不会报 PIL 导入错误
- ✅ 不会出现 `_MEI` 临时目录相关的错误

### 测试 3：生产环境 - 文件被占用需延迟替换

**前提条件：**
- 已使用 `python build.py` 打包生成 exe
- exe 文件被占用（例如在更新过程中某些文件无法直接覆盖）

**步骤：**
1. 运行 `dist\Stellaris-DLC-Helper\Stellaris-DLC-Helper.exe`
2. 触发自动更新（如果有可用更新）
3. 等待更新下载和安装完成
4. 观察是否有 `.new` 文件生成
5. 点击"立即重启"按钮

**预期结果：**
- ✅ 应该显示提示：`更新已准备好，但需要重新启动以完成替换...`
- ✅ 日志中应该显示：`exe 替换已排程，退出以完成替换`
- ✅ 程序退出后，updater_helper 或批处理脚本应该自动替换文件并重启
- ✅ 新程序应该正常启动

## 验证要点

### 日志检查

查看日志文件（在 `Stellaris_DLC_Cache/logs/` 目录下），应该包含以下信息：

**开发环境：**
```
开发环境：重启程序: C:\...\python.exe ['main.py']
```

**生产环境（可直接替换）：**
```
exe 模式：启动新进程后退出: C:\...\Stellaris-DLC-Helper.exe
```

**生产环境（需延迟替换）：**
```
exe 替换已排程，退出以完成替换
```

### 进程检查

**开发环境：**
- 旧的 Python 进程应该终止
- 新的 Python 进程应该启动

**生产环境：**
- 旧的 exe 进程应该终止
- 新的 exe 进程应该启动
- 不应该出现多个 exe 进程同时运行的情况

### 错误检查

**不应该出现的错误：**
- ❌ `FileNotFoundError: ... customtkinter\assets\themes\blue.json`
- ❌ `ImportError: cannot import name '_imaging' from 'PIL'`
- ❌ `[Errno 2] No such file or directory`

## 常见问题排查

### Q1: 开发环境下重启失败
**检查：**
- 确认 Python 解释器路径是否正确
- 查看日志中的 `sys.argv` 是否正确
- 确认没有防火墙或安全软件阻止进程创建

### Q2: exe 模式下新进程无法启动
**检查：**
- 确认 exe 文件是否被防病毒软件拦截
- 查看是否有错误日志
- 确认工作目录是否正确设置

### Q3: 更新后程序版本没有变化
**检查：**
- 确认更新文件是否正确下载
- 查看 `version.json` 文件是否更新
- 确认文件替换是否成功（检查文件修改时间）

## 回归测试

完成以上测试后，还应该验证：
1. ✅ 正常的 DLC 下载功能是否正常
2. ✅ 正常的程序退出是否正常
3. ✅ 其他核心功能是否受影响

## 测试记录模板

```
测试日期：____年__月__日
测试人员：________
测试环境：□ 开发环境  □ 生产环境(exe)

测试项目 1：开发环境重启
- [ ] 程序正常重启
- [ ] 无错误提示
- [ ] 日志正确

测试项目 2：exe 直接替换
- [ ] 新进程正常启动
- [ ] 旧进程正常退出
- [ ] 无 PIL 导入错误

测试项目 3：exe 延迟替换
- [ ] updater_helper 正常工作
- [ ] 文件替换成功
- [ ] 程序自动重启

问题记录：
_____________________________________
_____________________________________
```

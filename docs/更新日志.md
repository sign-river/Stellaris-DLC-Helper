# 更新日志

## 版本历史

### v1.0.5 (2026-01-30)-未发布

#### 🐛 重要 Bug 修复

##### 1. 修复 DLC 列表加载逻辑错误

- ✅ **问题**：空列表判断逻辑错误导致误报"服务器上暂无可用 DLC"
- ✅ **原因**：代码使用 `if dlc_list:` 无法区分 API 失败 (None) 和返回空列表 ([])
- ✅ **修复**：改用 `if dlc_list is None:` 明确区分两种情况
- ✅ **影响**：修复部分用户遇到的 DLC 列表无法加载问题

##### 2. 增强错误诊断能力

- ✅ 新增详细的调试日志输出
- ✅ 记录附件解析过程（跳过的文件及原因）
- ✅ 改进错误提示信息的准确性

#### 🛠️ 新增工具

##### 1. API 诊断工具

- ✅ 新增 `diagnose_dlc_api.py` 诊断脚本
- ✅ 自动检测网络连接、API 响应、数据解析等问题
- ✅ 提供详细的诊断报告和解决建议
- ✅ 测试 DLC 下载 URL 可用性

##### 2. 故障排查文档

- ✅ 新增 `DLC 列表加载失败排查指南。md`
- ✅ 详细说明可能的故障原因和解决方案
- ✅ 提供常见问题 FAQ
- ✅ 包含代码改进说明

#### 📝 代码改进

修复前：

```python
def fetch_dlc_list(self):
    dlc_list = self._fetch_from_gitlink_api()
    if dlc_list:  # ❌ 空列表 [] 会被判为 False
        return dlc_list
    raise Exception("无法获取 DLC 列表：GitLink API 访问失败")
```

修复后：

```python
def fetch_dlc_list(self):
    dlc_list = self._fetch_from_gitlink_api()

    # ✅ 明确区分 None 和空列表
    if dlc_list is None:
        raise Exception("无法获取 DLC 列表：GitLink API 访问失败")

    if not dlc_list:
        raise Exception("服务器上暂无可用 DLC（API 返回为空）")

    return dlc_list
```

---

### v1.0.4 (2026-01-12)

#### 🚀 重大改进

##### 1. 简化为单一 GitLink 源

- ✅ 移除多源配置，专注 GitLink 单一高速源
- ✅ 删除废弃的启动测速功能
- ✅ 简化配置管理，提升用户体验

##### 2. 新增独立测速功能

- ✅ 在设置中新增"测速"选项卡
- ✅ 实时显示下载速度（每 0.3 秒更新）
- ✅ 大号数字显示测速结果
- ✅ 根据速度自动评级（⭐⭐⭐⭐⭐）
- ✅ 使用 70MB 测试文件，准确评估网络速度

##### 3. UI 优化

- ✅ 设置对话框布局优化，统一使用可滚动容器
- ✅ 测速界面左右分栏显示（左侧描述，右侧速度）
- ✅ 速度显示根据快慢使用不同颜色（绿→黄→红）

#### 🐛 Bug 修复

- ✅ 修复下载进度条参数顺序错误
- ✅ 修复 Lambda 闭包导致的进度显示问题
- ✅ 修复 DLC 列表文件大小不显示的问题
- ✅ 修复恢复下载时进度超过 100%的问题
- ✅ 修复 GitLink API 返回格式化字符串的解析

#### 🎯 性能优化

- ✅ 优化启动速度，减少网络超时等待
- ✅ DLC 列表按编号自动排序
- ✅ 显示游戏版本信息

---

### v1.0.3 (2025-12-05)

#### 🚀 重大改进

##### 1. 更新系统全面优化

**更新速度大幅提升**：

- 修复前：11 秒（10 秒浪费在重试 updater_helper）
- 修复后：1-2 秒 🚀（提升 **80%**）

**核心改进**：

- ✅ 修复 updater_helper.exe 无法自我更新的问题
- ✅ 添加详细的分步骤日志（[步骤 X/4]）
- ✅ 优化重试机制（20 次→10 次）
- ✅ 实现双重清理机制（启动时立即清理）
- ✅ config.json 智能合并（保留用户配置）

**技术细节**：

```
更新流程：
1. updater_helper 跳过自己，保留 .new 文件
2. 主程序启动时立即检测并替换 updater_helper.exe
3. 双重清理确保无残留
```

##### 2. 配置文件更新策略改进

**问题**：之前跳过 config.json 更新，导致新配置项无法添加

**解决方案**：

- ✅ 智能合并配置文件
- ✅ 保留用户自定义配置：
  - `game_path` - 游戏路径
  - `steam_path` - Steam 路径
  - `server.sources` - 自定义服务器源
- ✅ 添加新版本的配置项
- ✅ 版本号自动更新

#### 🎨 UI 改进

##### 设置对话框新增功能

**更新文件管理**：

- ✅ 添加滚动条支持（内容过多时不遮挡）
- ✅ 三个清理按钮：
  - 清理临时文件（.new 文件）
  - 清理备份文件
  - 清理更新下载包（系统临时文件夹）
- ✅ 实时显示文件统计（数量和大小）
- ✅ 蓝色主题按钮（#1976D2）

#### 📝 日志系统增强

##### updater_helper 详细日志

**新增日志位置**：`Stellaris_DLC_Cache/operation_logs/updater_helper.log`

**日志内容**：

```
[步骤 1/4] 等待主程序退出 (PID=xxx)...
主程序已退出 （等待时间：0.23 秒）

[步骤 2/4] 读取批处理配置。..

[步骤 3/4] 开始替换 2 个文件。..
  [1/2] 处理：Stellaris-DLC-Helper.exe
    ✔ 替换成功 （尝试 2 次，耗时 1.01 秒）
  [2/2] 处理：updater_helper.exe
    ⊙ 跳过（保留 .new 文件供主程序启动时替换）

[步骤 4/4] 准备启动新版本程序。..
  ✔ 程序已启动
```

#### 🐛 Bug 修复

##### 更新重启慢问题

- 问题：点击"立即重启"后等待 15-26 秒
- 原因：updater_helper 尝试替换自己，重试 10 次失败
- 修复：跳过自身替换，主程序启动时接管

##### .new 文件残留问题

- 问题：更新后残留 updater_helper.exe.new
- 修复：双重清理机制（main.py + updater.py）
- 结果：无残留文件 ✅

##### 版本号显示问题

- 问题：更新后版本号不更新（因为 config.json 被跳过）
- 修复：config.json 智能合并策略
- 结果：版本号正确显示 ✅

---

### v1.0.2 (2025-12-04)

#### 🐛 Bug 修复

##### 1. 缓存文件完整性验证

**问题：** 损坏的缓存文件导致安装失败，提示 "Bad magic number for file header"

**原因：**

- `download_dlc` 方法在发现缓存文件存在时直接返回，不验证文件完整性
- 损坏的缓存文件（网络中断导致）被重复使用
- 缺少 ZIP 格式验证

**修复：**

- 添加 `_verify_cached_file` 方法，进行三重验证：
  - 文件大小检查（至少 1KB）
  - ZIP 格式完整性验证
  - SHA256 哈希校验（可选）
- 自动检测并删除损坏的缓存文件
- 自动重新下载完整文件

**用户影响：**

- ✅ 自动处理损坏的缓存文件
- ✅ 无需手动删除缓存目录
- ✅ 提高下载成功率

##### 2. 源选取优化相关 Bug 修复

**Bug 2.1: `primary_source_name` 变量未定义**

```
NameError: name 'primary_source_name' is not defined
```

- 修复 `_download_single_attempt` 方法中的参数传递
- 使用正确的 `current_source_name` 参数

**Bug 2.2: Gitee URL 生成错误**

```
404 Client Error: Not Found
```

- 修复 Gitee URL 构建逻辑，添加 `/releases/download/` 路径
- 修复 `source_url` 的提取逻辑
- 更新 `config.json` 中的 Gitee 配置格式

**Bug 2.3: GUI 异常处理作用域问题**

```
UnboundLocalError: cannot access local variable 'e'
```

- 修复 `main_window.py` 中异常变量的作用域
- 使用 `last_exception` 保存异常状态

#### ⚡ 性能优化

##### 智能测速系统优化

- **国内云阈值调整**：3.0 MB/s → 4.0 MB/s
- **预热式测速机制**：
  - 前 3 秒预热（TCP 慢启动）
  - 后 7-10 秒正式测速
  - 测速结果更准确
- **Gitee 纯保底策略**：
  - 跳过测速节省时间
  - 仅在所有源不达标时使用
  - 使用预估速度 2.5 MB/s

##### 下载速度监控

- **DLC 级别监控**：每个 DLC 独立计时，互不干扰
- **智能切源**：
  - 慢速阈值：1.0 MB/s
  - 持续时间：30 秒
  - 5 分钟测速缓存复用
- **超时优化**：
  - 连接超时：10 秒（快速失败）
  - 读取超时：60 秒（给速度监控时间）

#### 📝 配置文件更新

更新 `config.json` 中的 Gitee 配置：

```json
{
  "name": "gitee",
  "url": "https://gitee.com/signriver/file_warehouse",
  "format": "gitee_release",
  "releases": {
    "ste1-26": { "min": 1, "max": 26 },
    "ste27-39": { "min": 27, "max": 39 }
  }
}
```

---

### v1.0.1 (2024-12-XX)

#### 功能改进

- 优化日志系统架构
- 改进错误处理机制
- 增强配置管理功能

---

### v1.0.0 (2024-11-30) - 初始发布

#### ✨ 核心功能

- 🎮 **一键解锁** - 自动检测游戏路径，一键下载安装所有 DLC
- 🚀 **智能测速** - 三级阈值策略，自动选择最快下载源
- ☁️ **多源下载** - R2、GitHub、国内云、Gitee 四源智能切换
- 💾 **断点续传** - 支持暂停/恢复下载，网络中断自动续传
- 🔄 **自动更新** - 内置更新检查，支持静默升级
- 📢 **公告推送** - 及时获取重要通知和维护信息
- 📝 **操作日志** - 完整记录所有操作，支持导出
- 🎨 **现代界面** - CustomTkinter 现代化 UI
- 🔒 **补丁管理** - CreamAPI 补丁自动应用与还原

#### 支持的平台

- Windows 7/8/10/11 (64 位）

#### 已知问题

- 某些杀毒软件可能误报（需添加白名单）
- 网络不稳定时可能需要多次重试

---

## 自动更新功能说明

### 更新流程

1. 内置检测更新、下载、安装与回滚的工作流程
2. 通过 `src/core/updater.py` 与 `src/gui/update_dialog.py` 协同进行
3. 要求服务器上有 `update/version.json` 与版本包 `v{version}/`

### 版本信息格式

```json
{
  "latest_version": "1.1.0",
  "force_update": false,
  "update_url": "https://example.com/update/v1.1.0/app.zip",
  "update_log": "https://example.com/update/v1.1.0/changelog.txt",
  "min_version": "1.0.0",
  "release_date": "2024-11-30",
  "file_size": "25.5MB",
  "checksum": "SHA256 哈希值"
}
```

### 更新验证与回滚

- 下载完成后验证文件大小/哈希
- 若校验失败或安装异常，支持回滚到上一个版本

### 多源下载部署要点

- 部署时同时保持 R2、GitHub、国内云与 Gitee 多源镜像以保证高可用
- `pairings.json` 需与 GitHub/Gitee release 文件名一致

---

## 联系与支持

- **GitHub Issues**: <https://github.com/sign-river/Stellaris-DLC-Helper/issues>
- **QQ 群**: 1051774780

---

## 贡献指南

欢迎提交问题报告和功能建议！详见 [开发文档](开发文档。md)。

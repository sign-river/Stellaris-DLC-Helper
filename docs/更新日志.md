# 更新日志

## 版本历史

### v1.0.4 (2026-01-12)

#### 🚀 重大改进

##### 1. 简化为单一GitLink源
- ✅ 移除多源配置，专注GitLink单一高速源
- ✅ 删除废弃的启动测速功能
- ✅ 简化配置管理，提升用户体验

##### 2. 新增独立测速功能
- ✅ 在设置中新增"测速"选项卡
- ✅ 实时显示下载速度（每0.3秒更新）
- ✅ 大号数字显示测速结果
- ✅ 根据速度自动评级（⭐⭐⭐⭐⭐）
- ✅ 使用70MB测试文件，准确评估网络速度

##### 3. UI优化
- ✅ 设置对话框布局优化，统一使用可滚动容器
- ✅ 测速界面左右分栏显示（左侧描述，右侧速度）
- ✅ 速度显示根据快慢使用不同颜色（绿→黄→红）

#### 🐛 Bug修复
- ✅ 修复下载进度条参数顺序错误
- ✅ 修复Lambda闭包导致的进度显示问题
- ✅ 修复DLC列表文件大小不显示的问题
- ✅ 修复恢复下载时进度超过100%的问题
- ✅ 修复GitLink API返回格式化字符串的解析

#### 🎯 性能优化
- ✅ 优化启动速度，减少网络超时等待
- ✅ DLC列表按编号自动排序
- ✅ 显示游戏版本信息

---

### v1.0.3 (2025-12-05)

#### 🚀 重大改进

##### 1. 更新系统全面优化
**更新速度大幅提升**：
- 修复前：11秒（10秒浪费在重试 updater_helper）
- 修复后：1-2秒 🚀（提升 **80%**）

**核心改进**：
- ✅ 修复 updater_helper.exe 无法自我更新的问题
- ✅ 添加详细的分步骤日志（[步骤X/4]）
- ✅ 优化重试机制（20次→10次）
- ✅ 实现双重清理机制（启动时立即清理）
- ✅ config.json 智能合并（保留用户配置）

**技术细节**：
```
更新流程：
1. updater_helper 跳过自己，保留 .new 文件
2. 主程序启动时立即检测并替换 updater_helper.exe
3. 双重清理确保无残留
```

##### 2. 配置文件更新策略改进
**问题**：之前跳过 config.json 更新，导致新配置项无法添加

**解决方案**：
- ✅ 智能合并配置文件
- ✅ 保留用户自定义配置：
  - `game_path` - 游戏路径
  - `steam_path` - Steam 路径
  - `server.sources` - 自定义服务器源
- ✅ 添加新版本的配置项
- ✅ 版本号自动更新

#### 🎨 UI改进

##### 设置对话框新增功能
**更新文件管理**：
- ✅ 添加滚动条支持（内容过多时不遮挡）
- ✅ 三个清理按钮：
  - 清理临时文件（.new 文件）
  - 清理备份文件
  - 清理更新下载包（系统临时文件夹）
- ✅ 实时显示文件统计（数量和大小）
- ✅ 蓝色主题按钮（#1976D2）

#### 📝 日志系统增强

##### updater_helper 详细日志
**新增日志位置**：`Stellaris_DLC_Cache/operation_logs/updater_helper.log`

**日志内容**：
```
[步骤1/4] 等待主程序退出 (PID=xxx)...
主程序已退出 (等待时间: 0.23秒)

[步骤2/4] 读取批处理配置...

[步骤3/4] 开始替换 2 个文件...
  [1/2] 处理: Stellaris-DLC-Helper.exe
    ✔ 替换成功 (尝试 2 次, 耗时 1.01秒)
  [2/2] 处理: updater_helper.exe
    ⊙ 跳过（保留 .new 文件供主程序启动时替换）

[步骤4/4] 准备启动新版本程序...
  ✔ 程序已启动
```

#### 🐛 Bug修复

##### 更新重启慢问题
- 问题：点击"立即重启"后等待15-26秒
- 原因：updater_helper 尝试替换自己，重试10次失败
- 修复：跳过自身替换，主程序启动时接管

##### .new 文件残留问题
- 问题：更新后残留 updater_helper.exe.new
- 修复：双重清理机制（main.py + updater.py）
- 结果：无残留文件 ✅

##### 版本号显示问题
- 问题：更新后版本号不更新（因为 config.json 被跳过）
- 修复：config.json 智能合并策略
- 结果：版本号正确显示 ✅

---

### v1.0.2 (2025-12-04)

#### 🐛 Bug修复

##### 1. 缓存文件完整性验证
**问题：** 损坏的缓存文件导致安装失败，提示 "Bad magic number for file header"

**原因：**
- `download_dlc` 方法在发现缓存文件存在时直接返回，不验证文件完整性
- 损坏的缓存文件（网络中断导致）被重复使用
- 缺少ZIP格式验证

**修复：**
- 添加 `_verify_cached_file` 方法，进行三重验证：
  - 文件大小检查（至少1KB）
  - ZIP格式完整性验证
  - SHA256哈希校验（可选）
- 自动检测并删除损坏的缓存文件
- 自动重新下载完整文件

**用户影响：**
- ✅ 自动处理损坏的缓存文件
- ✅ 无需手动删除缓存目录
- ✅ 提高下载成功率

##### 2. 源选取优化相关Bug修复

**Bug 2.1: `primary_source_name` 变量未定义**
```
NameError: name 'primary_source_name' is not defined
```
- 修复 `_download_single_attempt` 方法中的参数传递
- 使用正确的 `current_source_name` 参数

**Bug 2.2: Gitee URL生成错误**
```
404 Client Error: Not Found
```
- 修复 Gitee URL 构建逻辑，添加 `/releases/download/` 路径
- 修复 `source_url` 的提取逻辑
- 更新 `config.json` 中的 Gitee 配置格式

**Bug 2.3: GUI异常处理作用域问题**
```
UnboundLocalError: cannot access local variable 'e'
```
- 修复 `main_window.py` 中异常变量的作用域
- 使用 `last_exception` 保存异常状态

#### ⚡ 性能优化

##### 智能测速系统优化
- **国内云阈值调整**：3.0 MB/s → 4.0 MB/s
- **预热式测速机制**：
  - 前3秒预热（TCP慢启动）
  - 后7-10秒正式测速
  - 测速结果更准确
- **Gitee纯保底策略**：
  - 跳过测速节省时间
  - 仅在所有源不达标时使用
  - 使用预估速度2.5 MB/s

##### 下载速度监控
- **DLC级别监控**：每个DLC独立计时，互不干扰
- **智能切源**：
  - 慢速阈值：1.0 MB/s
  - 持续时间：30秒
  - 5分钟测速缓存复用
- **超时优化**：
  - 连接超时：10秒（快速失败）
  - 读取超时：60秒（给速度监控时间）

#### 📝 配置文件更新
更新 `config.json` 中的 Gitee 配置：
```json
{
  "name": "gitee",
  "url": "https://gitee.com/signriver/file_warehouse",
  "format": "gitee_release",
  "releases": {
    "ste1-26": { "min": 1, "max": 26 },
    "ste27-39": { "min": 27, "max": 39 }
  }
}
```

---

### v1.0.1 (2024-12-XX)

#### 功能改进
- 优化日志系统架构
- 改进错误处理机制
- 增强配置管理功能

---

### v1.0.0 (2024-11-30) - 初始发布

#### ✨ 核心功能
- 🎮 **一键解锁** - 自动检测游戏路径，一键下载安装所有DLC
- 🚀 **智能测速** - 三级阈值策略，自动选择最快下载源
- ☁️ **多源下载** - R2、GitHub、国内云、Gitee四源智能切换
- 💾 **断点续传** - 支持暂停/恢复下载，网络中断自动续传
- 🔄 **自动更新** - 内置更新检查，支持静默升级
- 📢 **公告推送** - 及时获取重要通知和维护信息
- 📝 **操作日志** - 完整记录所有操作，支持导出
- 🎨 **现代界面** - CustomTkinter现代化UI
- 🔒 **补丁管理** - CreamAPI补丁自动应用与还原

#### 支持的平台
- Windows 7/8/10/11 (64位)

#### 已知问题
- 某些杀毒软件可能误报（需添加白名单）
- 网络不稳定时可能需要多次重试

---

## 自动更新功能说明

### 更新流程
1. 内置检测更新、下载、安装与回滚的工作流程
2. 通过 `src/core/updater.py` 与 `src/gui/update_dialog.py` 协同进行
3. 要求服务器上有 `update/version.json` 与版本包 `v{version}/`

### 版本信息格式
```json
{
  "latest_version": "1.1.0",
  "force_update": false,
  "update_url": "https://example.com/update/v1.1.0/app.zip",
  "update_log": "https://example.com/update/v1.1.0/changelog.txt",
  "min_version": "1.0.0",
  "release_date": "2024-11-30",
  "file_size": "25.5MB",
  "checksum": "SHA256哈希值"
}
```

### 更新验证与回滚
- 下载完成后验证文件大小/哈希
- 若校验失败或安装异常，支持回滚到上一个版本

### 多源下载部署要点
- 部署时同时保持 R2、GitHub、国内云与 Gitee 多源镜像以保证高可用
- `pairings.json` 需与 GitHub/Gitee release 文件名一致

---

## 联系与支持

- **GitHub Issues**: https://github.com/sign-river/Stellaris-DLC-Helper/issues
- **QQ群**: 1051774780

---

## 贡献指南

欢迎提交问题报告和功能建议！详见[开发文档](开发文档.md)。

# 自动更新功能实现说明

## 概述

已实现完整的自动更新功能，包括检查更新、下载更新包、应用更新和回滚机制。

## 实现的文件

### 1. `src/core/updater.py`
自动更新核心模块，包含：
- `UpdateInfo` 类：处理版本信息
- `AutoUpdater` 类：更新检查、下载、应用功能

### 2. `src/gui/update_dialog.py`
更新对话框模块，提供用户界面：
- 更新检查提示
- 下载进度显示
- 安装状态反馈
- 错误处理和重试

### 3. `src/gui/main_window.py` (修改)
集成更新功能到主界面：
- 修改"检查更新"按钮功能
- 添加启动时自动检查更新

## 功能特性

### 版本管理
- 语义化版本支持 (Semantic Versioning)
- 强制更新和可选更新
- 最低版本要求

### 用户体验
- 启动时自动检查更新（仅强制更新弹窗）
- 手动检查更新按钮
- 下载进度条显示
- 友好的错误提示

### 安全性
- 文件完整性验证（预留checksum字段）
- 自动备份当前版本
- 失败时自动回滚

### 网络处理
- 超时和重试机制
- 断点续传支持（预留）
- 代理支持（继承现有配置）

## 使用流程

1. **启动检查**：程序启动2秒后自动检查更新
2. **手动检查**：点击"检查更新"按钮
3. **更新提示**：发现新版本时显示对话框
4. **下载安装**：用户确认后自动下载和安装
5. **完成重启**：更新完成后提示重启程序

## 配置要求

需要在R2存储库设置以下文件结构：

```
dlc.dlchelper.top/update/
├── version.json          # 版本信息
└── v{版本}/
    ├── Stellaris-DLC-Helper-v{版本}.zip    # 更新包
    └── update.log         # 更新日志
```

## 版本信息格式 (version.json)

```json
{
  "latest_version": "1.1.0",
  "force_update": false,
  "update_url": "https://dlc.dlchelper.top/update/v1.1.0/Stellaris-DLC-Helper-v1.1.0.zip",
  "update_log": "https://dlc.dlchelper.top/update/v1.1.0/update.log",
  "min_version": "1.0.0",
  "release_date": "2024-11-30",
  "file_size": "25.5MB",
  "checksum": "可选的文件校验码"
}
```

## 测试建议

1. 上传测试版本信息到R2
2. 运行程序测试自动检查功能
3. 创建测试更新包进行完整更新流程测试
4. 测试网络异常情况的处理

## 注意事项

- 更新包应为完整的打包文件夹压缩文件
- 确保更新包的文件结构与当前版本一致
- 配置文件会自动保留，不会被覆盖
- 更新失败时会自动尝试回滚